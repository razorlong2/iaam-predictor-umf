#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
IAAM PREDICTOR SIMPLU - TEST FUNC»öIONAL
Dr. Boghian Lucian - UMF "Grigore T. Popa" Ia»ôi
Versiune simplƒÉ pentru testare rapidƒÉ
"""

import streamlit as st
import plotly.graph_objects as go
import pandas as pd
import numpy as np
from datetime import datetime
import json

# Configurare paginƒÉ
st.set_page_config(
    page_title="üè• IAAM Predictor Test",
    page_icon="üè•",
    layout="wide"
)

# CSS simplu
st.markdown("""
<style>
    .header {
        background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
        padding: 2rem;
        border-radius: 10px;
        color: white;
        margin-bottom: 2rem;
        text-align: center;
    }
    .alert-red {
        background: #ffe6e6;
        border-left: 5px solid #ff4444;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 5px;
    }
    .alert-orange {
        background: #fff3e0;
        border-left: 5px solid #ff9800;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 5px;
    }
    .alert-yellow {
        background: #fffde7;
        border-left: 5px solid #ffeb3b;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 5px;
    }
    .alert-green {
        background: #e8f5e8;
        border-left: 5px solid #4caf50;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 5px;
    }
</style>
""", unsafe_allow_html=True)

def calculeaza_scor_iaam(date):
    """CalculeazƒÉ scorul IAAM conform ghidurilor"""
    scor = 0
    detalii = []
    
    # 1. VERIFICARE CRITERIU TEMPORAL (obligatoriu)
    ore = date.get('ore_spitalizare', 0)
    if ore < 48:
        return 0, "‚ùå NU IAAM - Criteriu temporal ne√Ændeplinit", [], []
    
    # Punctaj pentru timpul de spitalizare
    if 48 <= ore < 72:
        scor += 5
        detalii.append("‚è∞ IAAM posibilƒÉ (48-72h): +5 puncte")
    elif 72 <= ore < 168:  # 7 zile
        scor += 10
        detalii.append("‚è∞ IAAM confirmatƒÉ (3-7 zile): +10 puncte")
    else:  # >7 zile
        scor += 15
        detalii.append("‚è∞ IAAM tardivƒÉ (>7 zile): +15 puncte")
    
    # 2. FACTORI CARMELI MDR
    carmeli_scor = 0
    if date.get('spitalizare_90zile', False):
        carmeli_scor += 1
        scor += 10
        detalii.append("üè• Spitalizare √Æn 90 zile: +10 puncte")
    
    if date.get('antibiotice_30zile', False):
        carmeli_scor += 1
        scor += 15
        detalii.append("üíä Antibiotice √Æn 30 zile: +15 puncte")
    
    if date.get('rezidenta_ilp', False):
        carmeli_scor += 1
        scor += 10
        detalii.append("üè† Reziden»õƒÉ institu»õionalƒÉ: +10 puncte")
    
    # Bonus pentru scor Carmeli maxim
    if carmeli_scor == 3:
        scor += 10
        detalii.append("üéØ Bonus Carmeli maxim (3/3): +10 puncte")
    
    # 3. DISPOZITIVE INVAZIVE
    if date.get('cvc', False):
        scor += 25
        detalii.append("üíâ Cateter venos central: +25 puncte")
    
    if date.get('ventilatie', False):
        scor += 30
        detalii.append("ü´Å Ventila»õie mecanicƒÉ: +30 puncte")
    
    if date.get('sonda_urinara', False):
        scor += 15
        detalii.append("üöΩ SondƒÉ urinarƒÉ: +15 puncte")
    
    if date.get('traheostomie', False):
        scor += 20
        detalii.append("ü¶¥ Traheostomie: +20 puncte")
    
    if date.get('drenaj', False):
        scor += 10
        detalii.append("üíß Drenaj activ: +10 puncte")
    
    # 4. FACTORI DEMOGRAFICI
    varsta = date.get('varsta', 0)
    if varsta > 65:
        scor += 10
        detalii.append(f"üë¥ V√¢rstƒÉ >65 ani ({varsta}): +10 puncte")
    elif varsta < 1:
        scor += 15
        detalii.append(f"üë∂ Sugar <1 an: +15 puncte")
    
    # 5. COMORBIDITƒÇ»öI
    if date.get('diabet', False):
        scor += 10
        detalii.append("üç≠ Diabet zaharat: +10 puncte")
    
    if date.get('imunosupresie', False):
        scor += 20
        detalii.append("üõ°Ô∏è Imunosupresie: +20 puncte")
    
    if date.get('bpoc', False):
        scor += 8
        detalii.append("ü´Å BPOC: +8 puncte")
    
    if date.get('insuf_renala', False):
        scor += 12
        detalii.append("ü´ò Insuficien»õƒÉ renalƒÉ: +12 puncte")
    
    if date.get('neoplasm', False):
        scor += 15
        detalii.append("üéóÔ∏è Neoplasm activ: +15 puncte")
    
    # 6. PARAMETRI LABORATOR
    leucocite = date.get('leucocite', 7000)
    if leucocite > 12000:
        scor += 8
        detalii.append(f"üß™ LeucocitozƒÉ ({leucocite:,}): +8 puncte")
    elif leucocite < 4000:
        scor += 10
        detalii.append(f"üß™ Leucopenie ({leucocite:,}): +10 puncte")
    
    crp = date.get('crp', 5)
    if crp > 50:
        scor += 6
        detalii.append(f"üî• CRP √Ænalt ({crp} mg/L): +6 puncte")
    
    pct = date.get('pct', 0.1)
    if pct > 2:
        scor += 12
        detalii.append(f"‚ö° ProcalcitoninƒÉ √ÆnaltƒÉ ({pct} ng/mL): +12 puncte")
    
    # 7. MICROBIOLOGIE
    if date.get('cultura_pozitiva', False):
        scor += 10
        detalii.append("ü¶† CulturƒÉ pozitivƒÉ: +10 puncte")
        
        bacterie = date.get('bacterie', '')
        if bacterie:
            scor += 15
            detalii.append(f"‚ö†Ô∏è Bacterie MDR ({bacterie}): +15 puncte")
    
    # Determinare nivel risc
    if scor >= 100:
        nivel = "üî¥ CRITIC"
        culoare = "red"
    elif scor >= 75:
        nivel = "üî¥ FOARTE √éNALT"
        culoare = "red"
    elif scor >= 50:
        nivel = "üü† √éNALT"
        culoare = "orange"
    elif scor >= 30:
        nivel = "üü° MODERAT"
        culoare = "yellow"
    else:
        nivel = "üü¢ SCƒÇZUT"
        culoare = "green"
    
    # Generare recomandƒÉri
    recomandari = genereaza_recomandari(scor)
    
    return scor, nivel, detalii, recomandari

def genereaza_recomandari(scor):
    """GenereazƒÉ recomandƒÉri bazate pe scor"""
    if scor >= 100:
        return [
            "üö® ALERTƒÇ CPIAAM IMEDIATƒÇ (0-30 min)",
            "üß™ Screening MDR URGENT √Æn 1 orƒÉ",
            "üîí Izolare STRICTƒÇ + precau»õii contact",
            "üíä Antibioterapie empiricƒÉ spectru FOARTE LARG",
            "üìû Consultare infectionist STAT",
            "üìä Monitorizare parametri vitali la 1h",
            "üè• Evaluare transfer ATI dacƒÉ instabil"
        ]
    elif scor >= 75:
        return [
            "‚è∞ AlertƒÉ CPIAAM √Æn 30 minute",
            "üß™ Screening MDR rapid √Æn 2 ore",
            "üîí Izolare preventivƒÉ imediatƒÉ",
            "üíä Considerare antibioterapie spectru larg",
            "üìà Monitorizare intensivƒÉ la 4h",
            "üßº Audit igiena m√¢inilor"
        ]
    elif scor >= 50:
        return [
            "üìû Consultare CPIAAM √Æn 2 ore",
            "üß™ Recoltare culturi complete",
            "üß§ Precau»õii contact standard",
            "üíä Revizuire antibioterapie curentƒÉ",
            "üìä Monitorizare zilnicƒÉ",
            "üîÑ Reevaluare la 48h"
        ]
    elif scor >= 30:
        return [
            "üëÅÔ∏è Supraveghere activƒÉ IAAM",
            "üß§ Bundle preven»õie standard",
            "üìä Monitorizare parametri clinici",
            "üîÑ Reevaluare la 72h",
            "üìã Documentare factori de risc"
        ]
    else:
        return [
            "üìã Monitorizare standard",
            "üß§ MƒÉsuri preventive de bazƒÉ",
            "üìã Documentare corespunzƒÉtoare",
            "üîÑ Reevaluare sƒÉptƒÉm√¢nalƒÉ"
        ]

def creeaza_gauge(scor):
    """CreeazƒÉ indicator vizual pentru scor"""
    if scor >= 75:
        color = "red"
    elif scor >= 50:
        color = "orange"
    elif scor >= 30:
        color = "yellow"
    else:
        color = "green"
    
    fig = go.Figure(go.Indicator(
        mode="gauge+number+delta",
        value=scor,
        domain={'x': [0, 1], 'y': [0, 1]},
        title={'text': "Scor IAAM", 'font': {'size': 24}},
        delta={'reference': 50, 'increasing': {'color': "red"}},
        gauge={
            'axis': {'range': [None, 120], 'tickwidth': 1, 'tickcolor': "darkblue"},
            'bar': {'color': color},
            'bgcolor': "white",
            'borderwidth': 2,
            'bordercolor': "gray",
            'steps': [
                {'range': [0, 30], 'color': "lightgreen"},
                {'range': [30, 50], 'color': "yellow"},
                {'range': [50, 75], 'color': "orange"},
                {'range': [75, 120], 'color': "lightcoral"}
            ],
            'threshold': {
                'line': {'color': "red", 'width': 4},
                'thickness': 0.75,
                'value': 90
            }
        }
    ))
    
    fig.update_layout(
        height=350,
        font={'color': "darkblue", 'family': "Arial"}
    )
    
    return fig

def main():
    """Func»õia principalƒÉ"""
    
    # Header
    st.markdown("""
    <div class="header">
        <h1>üè• SISTEM PREDIC»öIE IAAM - TEST SIMPLU</h1>
        <p><strong>Dr. Boghian Lucian</strong> - Doctorat Epidemiologie</p>
        <p>UMF "Grigore T. Popa" Ia»ôi</p>
        <p>Validat: Ord. 1101/2016 ‚Ä¢ CNSCBT ‚Ä¢ ECDC HAI-Net v5.3</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Sidebar pentru introducerea datelor
    st.sidebar.header("üìã Date Pacient")
    
    # Date de identificare
    nume_pacient = st.sidebar.text_input("Nume/Cod Pacient", "Test_001")
    
    # Date temporale
    st.sidebar.subheader("üìÖ Criterii Temporale")
    ore_spitalizare = st.sidebar.number_input(
        "Ore de la internare", 
        min_value=0, 
        max_value=720, 
        value=96,
        help="Timpul scurs de la internare p√¢nƒÉ la suspiciunea de infec»õie"
    )
    
    # Factori Carmeli
    st.sidebar.subheader("üéØ Factori Carmeli MDR")
    spitalizare_90zile = st.sidebar.checkbox(
        "Spitalizare √Æn ultimele 90 zile",
        help="Pacientul a fost spitalizat √Æn ultimele 3 luni"
    )
    antibiotice_30zile = st.sidebar.checkbox(
        "Antibiotice √Æn ultimele 30 zile",
        help="Administrare antibiotice √Æn ultima lunƒÉ"
    )
    rezidenta_ilp = st.sidebar.checkbox(
        "Reziden»õƒÉ √Æn institu»õie (ILP)",
        help="Pacient din cƒÉmin de bƒÉtr√¢ni sau institu»õie similarƒÉ"
    )
    
    # Dispozitive medicale
    st.sidebar.subheader("üîß Dispozitive Invazive")
    cvc = st.sidebar.checkbox("Cateter venos central")
    ventilatie = st.sidebar.checkbox("Ventila»õie mecanicƒÉ")
    sonda_urinara = st.sidebar.checkbox("SondƒÉ urinarƒÉ")
    traheostomie = st.sidebar.checkbox("Traheostomie")
    drenaj = st.sidebar.checkbox("Drenaj activ")
    
    # Date demografice
    st.sidebar.subheader("üë§ Date Demografice")
    varsta = st.sidebar.number_input("V√¢rsta (ani)", 0, 120, 70)
    
    # ComorbiditƒÉ»õi
    st.sidebar.subheader("ü©∫ ComorbiditƒÉ»õi")
    diabet = st.sidebar.checkbox("Diabet zaharat")
    imunosupresie = st.sidebar.checkbox("Imunosupresie/transplant")
    bpoc = st.sidebar.checkbox("BPOC")
    insuf_renala = st.sidebar.checkbox("Insuficien»õƒÉ renalƒÉ")
    neoplasm = st.sidebar.checkbox("Neoplasm activ")
    
    # Analize laborator
    st.sidebar.subheader("üß™ Analize Laborator")
    leucocite = st.sidebar.number_input("Leucocite (/mmc)", 0, 50000, 8500)
    crp = st.sidebar.number_input("CRP (mg/L)", 0.0, 500.0, 25.0)
    pct = st.sidebar.number_input("ProcalcitoninƒÉ (ng/mL)", 0.0, 50.0, 0.5)
    
    # Microbiologie
    st.sidebar.subheader("ü¶† Date Microbiologice")
    cultura_pozitiva = st.sidebar.checkbox("CulturƒÉ pozitivƒÉ")
    
    bacterie = ""
    if cultura_pozitiva:
        bacterii_disponibile = [
            "",
            "Escherichia coli",
            "Klebsiella pneumoniae", 
            "Pseudomonas aeruginosa",
            "Staphylococcus aureus",
            "Enterococcus faecalis",
            "Acinetobacter baumannii",
            "Candida albicans"
        ]
        bacterie = st.sidebar.selectbox("Bacterie identificatƒÉ", bacterii_disponibile)
    
    # Buton pentru calcularea scorului
    if st.sidebar.button("üîç CALCULEAZƒÇ SCOR IAAM", type="primary"):
        
        # PregƒÉtire date pentru calcul
        date_pacient = {
            'nume_pacient': nume_pacient,
            'ore_spitalizare': ore_spitalizare,
            'spitalizare_90zile': spitalizare_90zile,
            'antibiotice_30zile': antibiotice_30zile,
            'rezidenta_ilp': rezidenta_ilp,
            'cvc': cvc,
            'ventilatie': ventilatie,
            'sonda_urinara': sonda_urinara,
            'traheostomie': traheostomie,
            'drenaj': drenaj,
            'varsta': varsta,
            'diabet': diabet,
            'imunosupresie': imunosupresie,
            'bpoc': bpoc,
            'insuf_renala': insuf_renala,
            'neoplasm': neoplasm,
            'leucocite': leucocite,
            'crp': crp,
            'pct': pct,
            'cultura_pozitiva': cultura_pozitiva,
            'bacterie': bacterie
        }
        
        # Calculare scor
        scor, nivel_risc, detalii, recomandari = calculeaza_scor_iaam(date_pacient)
        
        # Afi»ôare rezultate
        if scor == 0:
            st.error("‚ùå **PACIENTUL NU √éNDEPLINE»òTE CRITERIUL TEMPORAL PENTRU IAAM**")
            st.info("**Recomandare:** Evalua»õi pentru infec»õie comunitarƒÉ (< 48h de la internare)")
        else:
            # Metrici principale
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric(
                    label="üéØ Scor Total IAAM",
                    value=f"{scor} puncte",
                    delta=f"vs. medie (45p)"
                )
            
            with col2:
                nivel_text = nivel_risc.split(' ', 1)[1] if ' ' in nivel_risc else nivel_risc
                st.metric(
                    label="üìä Nivel Risc",
                    value=nivel_text,
                    delta="Evaluare automatƒÉ"
                )
            
            with col3:
                carmeli_total = sum([spitalizare_90zile, antibiotice_30zile, rezidenta_ilp])
                st.metric(
                    label="üéØ Scor Carmeli",
                    value=f"{carmeli_total}/3",
                    delta="MDR predictor"
                )
            
            with col4:
                st.metric(
                    label="‚è±Ô∏è Data EvaluƒÉrii",
                    value=datetime.now().strftime("%H:%M"),
                    delta=datetime.now().strftime("%d.%m.%Y")
                )
            
            # Gauge »ôi detalii
            col1, col2 = st.columns([1, 1])
            
            with col1:
                # Gauge indicator
                fig_gauge = creeaza_gauge(scor)
                st.plotly_chart(fig_gauge, use_container_width=True)
            
            with col2:
                # Detalii calcul
                st.subheader("üìã Detalii Calcul Scor")
                for detaliu in detalii:
                    st.write(f"‚Ä¢ {detaliu}")
            
            # AlertƒÉ bazatƒÉ pe risc
            if scor >= 100:
                st.markdown(
                    f'<div class="alert-red"><strong>üö® ALERTƒÇ CRITICƒÇ IAAM</strong><br>'
                    f'Scor: {scor} puncte - AC»öIUNE IMEDIATƒÇ NECESARƒÇ!</div>',
                    unsafe_allow_html=True
                )
            elif scor >= 75:
                st.markdown(
                    f'<div class="alert-red"><strong>üî¥ RISC FOARTE √éNALT</strong><br>'
                    f'Scor: {scor} puncte - MƒÉsuri urgente necesare</div>',
                    unsafe_allow_html=True
                )
            elif scor >= 50:
                st.markdown(
                    f'<div class="alert-orange"><strong>üü† RISC √éNALT</strong><br>'
                    f'Scor: {scor} puncte - Supraveghere activƒÉ</div>',
                    unsafe_allow_html=True
                )
            elif scor >= 30:
                st.markdown(
                    f'<div class="alert-yellow"><strong>üü° RISC MODERAT</strong><br>'
                    f'Scor: {scor} puncte - Monitorizare atentƒÉ</div>',
                    unsafe_allow_html=True
                )
            else:
                st.markdown(
                    f'<div class="alert-green"><strong>üü¢ RISC SCƒÇZUT</strong><br>'
                    f'Scor: {scor} puncte - Monitorizare standard</div>',
                    unsafe_allow_html=True
                )
            
            # RecomandƒÉri clinice
            st.subheader("üí° RecomandƒÉri Clinice")
            
            for i, recomandare in enumerate(recomandari, 1):
                st.write(f"**{i}.** {recomandare}")
            
            # Informa»õii microbiologice
            if cultura_pozitiva and bacterie:
                st.subheader("ü¶† Informa»õii Microbiologice")
                st.info(f"**Bacterie identificatƒÉ:** {bacterie}")
                
                # Informa»õii despre rezisten»õe posibile
                bacterii_mdr_info = {
                    "Escherichia coli": "Posibile rezisten»õe: ESBL, Carbapenemaze",
                    "Klebsiella pneumoniae": "Posibile rezisten»õe: ESBL, Carbapenemaze, ColistinƒÉ",
                    "Pseudomonas aeruginosa": "Posibile rezisten»õe: Carbapenemaze, Quinolone",
                    "Staphylococcus aureus": "Posibile rezisten»õe: MRSA, VancomicinƒÉ",
                    "Enterococcus faecalis": "Posibile rezisten»õe: VRE, AmpicilinƒÉ",
                    "Acinetobacter baumannii": "Posibile rezisten»õe: XDR, Carbapenemaze",
                    "Candida albicans": "Posibile rezisten»õe: Azoli"
                }
                
                if bacterie in bacterii_mdr_info:
                    st.warning(f"‚ö†Ô∏è {bacterii_mdr_info[bacterie]}")
            
            # Raport pentru export
            st.subheader("üìÑ Raport Detaliat pentru Export")
            
            raport_text = f"""
RAPORT EVALUARE RISC IAAM
========================================

IDENTIFICARE PACIENT:
- Nume/Cod: {nume_pacient}
- Data evaluƒÉrii: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
- Evaluator: Dr. Boghian Lucian

REZULTATE EVALUARE:
- Scor total IAAM: {scor} puncte
- Nivel de risc: {nivel_risc}
- Ore de spitalizare: {ore_spitalizare}h
- Scor Carmeli MDR: {sum([spitalizare_90zile, antibiotice_30zile, rezidenta_ilp])}/3

FACTORI DE RISC IDENTIFICA»öI:
{chr(10).join([f"- {detaliu}" for detaliu in detalii])}

RECOMANDƒÇRI CLINICE:
{chr(10).join([f"{i}. {rec}" for i, rec in enumerate(recomandari, 1)])}

VALIDƒÇRI:
- Conform Ordinul MS 1101/2016
- CNSCBT - Defini»õii na»õionale
- ECDC HAI-Net Protocol v5.3

CONTACT:
UMF "Grigore T. Popa" Ia»ôi
Dr. Boghian Lucian - Doctorat Epidemiologie
            """
            
            st.text_area("Raport complet", raport_text, height=400)
            
            # Butoane pentru export
            col1, col2 = st.columns(2)
            
            with col1:
                st.download_button(
                    label="üì• DescarcƒÉ Raport TXT",
                    data=raport_text,
                    file_name=f"raport_iaam_{nume_pacient}_{datetime.now().strftime('%Y%m%d_%H%M')}.txt",
                    mime="text/plain"
                )
            
            with col2:
                # Export JSON pentru integrare
                date_export = {
                    **date_pacient,
                    'scor_calculat': scor,
                    'nivel_risc': nivel_risc,
                    'data_evaluare': datetime.now().isoformat(),
                    'recomandari': recomandari
                }
                
                st.download_button(
                    label="üì• DescarcƒÉ Date JSON",
                    data=json.dumps(date_export, indent=2, ensure_ascii=False),
                    file_name=f"date_iaam_{nume_pacient}_{datetime.now().strftime('%Y%m%d_%H%M')}.json",
                    mime="application/json"
                )
    
    # Reset button
    if st.sidebar.button("üîÑ Resetare Formular"):
        st.rerun()
    
    # Informa»õii generale (√Æntotdeauna vizibile)
    st.subheader("üìä Informa»õii Generale IAAM")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.info("""
        **üéØ Scor Carmeli MDR:**
        - 0 puncte: Risc scƒÉzut MDR
        - 1 punct: Risc moderat MDR  
        - 2 puncte: Risc √Ænalt MDR
        - 3 puncte: Risc maxim MDR
        """)
    
    with col2:
        st.info("""
        **üìä Interpretare Scor:**
        - 0-29p: üü¢ Risc scƒÉzut
        - 30-49p: üü° Risc moderat
        - 50-74p: üü† Risc √Ænalt
        - 75+p: üî¥ Risc critic
        """)
    
    with col3:
        st.info("""
        **‚è∞ Timeline Ac»õiuni:**
        - Risc critic: AlertƒÉ √Æn 30 min
        - Risc √Ænalt: Consultare √Æn 2h
        - Risc moderat: Monitorizare zilnicƒÉ
        - Risc scƒÉzut: Evaluare standard
        """)
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; color: gray; font-size: 14px;'>
        <p><strong>üè• SISTEM PREDIC»öIE IAAM v2.0</strong></p>
        <p>UMF "Grigore T. Popa" Ia»ôi | Dr. Boghian Lucian | Doctorat Epidemiologie</p>
        <p>Validat conform: Ord. 1101/2016 ‚Ä¢ CNSCBT ‚Ä¢ ECDC HAI-Net Protocol v5.3</p>
        <p><em>Pentru suport tehnic sau √ÆntrebƒÉri clinice, contacta»õi departamentul de Epidemiologie</em></p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
