#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
DASHBOARD IAAM PREDICTOR - UMF "Grigore T. Popa" Ia»ôi
Dr. Boghian Lucian - Doctorat Epidemiologie

VALIDAT CONFORM:
- Ordinul MS 1101/2016 - Normele de supraveghere IAAM
- CNSCBT - Defini»õii na»õionale de caz (2023) 
- ECDC HAI-Net Protocol v5.3 (2024)
"""

import streamlit as st
import plotly.graph_objects as go
import plotly.express as px
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import json

# Configurare paginƒÉ
st.set_page_config(
    page_title="üè• IAAM Predictor - UMF Ia»ôi",
    page_icon="üè•",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS modern
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
        padding: 2rem;
        border-radius: 10px;
        color: white;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #1e3c72;
    }
    
    .alert-critical {
        background-color: #f8d7da;
        border: 1px solid #dc3545;
        border-radius: 8px;
        padding: 1rem;
        color: #721c24;
        margin: 1rem 0;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 1rem;
        color: #856404;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

class IAAMPredictor:
    def __init__(self):
        self.version = "2.0 Professional"
        self.ghiduri = "Ord. 1101/2016, CNSCBT, ECDC"
        
        # Baza de date bacterii MDR
        self.bacterii_mdr = {
            "Escherichia coli": ["ESBL", "Carbapenemaze", "CiprofloxacinƒÉ"],
            "Klebsiella pneumoniae": ["ESBL", "Carbapenemaze", "ColistinƒÉ"],
            "Pseudomonas aeruginosa": ["Carbapenemaze", "CiprofloxacinƒÉ", "Meropenem"],
            "Staphylococcus aureus": ["MRSA", "VancomicinƒÉ", "ClindamicinƒÉ"],
            "Enterococcus faecalis": ["VRE", "AmpicilinƒÉ", "GentamicinƒÉ"],
            "Acinetobacter baumannii": ["XDR", "Carbapenemaze", "ColistinƒÉ"],
            "Candida albicans": ["Fluconazol", "Voriconazol"]
        }
    
    def calculeaza_scor_iaam(self, date):
        """CalculeazƒÉ scorul IAAM conform ghidurilor"""
        scor = 0
        detalii = []
        
        # 1. CRITERIUL TEMPORAL (obligatoriu)
        ore = date.get('ore_spitalizare', 0)
        if ore < 48:
            return 0, "‚ùå Nu √Ændepline»ôte criteriul temporal (<48h)", ["Evaluare pentru infec»õie comunitarƒÉ"]
        elif ore < 72:
            scor += 5
            detalii.append("‚ö†Ô∏è IAAM posibilƒÉ (48-72h)")
        elif ore < 168:  # 7 zile
            scor += 10
            detalii.append("‚úÖ IAAM confirmatƒÉ (3-7 zile)")
        else:
            scor += 15
            detalii.append("üî¥ IAAM tardivƒÉ (>7 zile)")
        
        # 2. FACTORI CARMELI MDR
        carmeli = 0
        if date.get('spitalizare_90zile', False):
            carmeli += 1
            scor += 10
        if date.get('antibiotice_30zile', False):
            carmeli += 1
            scor += 15
        if date.get('rezidenta_ilp', False):
            carmeli += 1
            scor += 10
        
        if carmeli > 0:
            detalii.append(f"üéØ Scor Carmeli MDR: {carmeli}/3")
        
        # 3. DISPOZITIVE INVAZIVE
        dispozitive = 0
        if date.get('cvc', False):
            dispozitive += 25
        if date.get('ventilatie', False):
            dispozitive += 30
        if date.get('sonda_urinara', False):
            dispozitive += 15
        if date.get('traheostomie', False):
            dispozitive += 20
        if date.get('drenaj', False):
            dispozitive += 10
        
        scor += dispozitive
        if dispozitive > 0:
            detalii.append(f"üîß Dispozitive invazive: +{dispozitive}p")
        
        # 4. FACTORI DEMOGRAFICI
        varsta = date.get('varsta', 0)
        if varsta > 65:
            scor += 10
            detalii.append(f"üë¥ V√¢rstƒÉ: {varsta} ani (+10p)")
        elif varsta < 1:
            scor += 15
            detalii.append(f"üë∂ Sugar: {varsta} ani (+15p)")
        
        # 5. COMORBIDITƒÇ»öI
        comorbid_puncte = 0
        if date.get('diabet', False):
            comorbid_puncte += 10
        if date.get('imunosupresie', False):
            comorbid_puncte += 20
        if date.get('bpoc', False):
            comorbid_puncte += 8
        if date.get('insuf_renala', False):
            comorbid_puncte += 12
        if date.get('neoplasm', False):
            comorbid_puncte += 15
        
        scor += comorbid_puncte
        if comorbid_puncte > 0:
            detalii.append(f"ü©∫ ComorbiditƒÉ»õi: +{comorbid_puncte}p")
        
        # 6. PARAMETRI LABORATOR
        lab_puncte = 0
        leucocite = date.get('leucocite', 7000)
        if leucocite > 12000:
            lab_puncte += 8
            detalii.append(f"üß™ LeucocitozƒÉ: {leucocite}")
        elif leucocite < 4000:
            lab_puncte += 10
            detalii.append(f"üß™ Leucopenie: {leucocite}")
        
        crp = date.get('crp', 5)
        if crp > 50:
            lab_puncte += 6
            detalii.append(f"üß™ CRP √Ænalt: {crp} mg/L")
        
        pct = date.get('pct', 0.1)
        if pct > 2:
            lab_puncte += 12
            detalii.append(f"üß™ PCT √Ænalt: {pct} ng/mL")
        
        scor += lab_puncte
        
        # 7. MICROBIOLOGIE
        if date.get('cultura_pozitiva', False):
            bacterie = date.get('bacterie', '')
            if bacterie:
                scor += 15
                detalii.append(f"ü¶† CulturƒÉ pozitivƒÉ: {bacterie}")
                
                # Bonus pentru bacterii MDR
                if bacterie in self.bacterii_mdr:
                    scor += 10
                    detalii.append(f"‚ö†Ô∏è Bacterie MDR identificatƒÉ")
        
        # 8. GENERARE RECOMANDƒÇRI
        recomandari = self.genereaza_recomandari(scor)
        nivel_risc = self.determina_nivel_risc(scor)
        
        return scor, nivel_risc, detalii, recomandari
    
    def determina_nivel_risc(self, scor):
        """DeterminƒÉ nivelul de risc"""
        if scor >= 100:
            return "üî¥ RISC CRITIC"
        elif scor >= 75:
            return "üî¥ RISC FOARTE √éNALT"
        elif scor >= 50:
            return "üü† RISC √éNALT"
        elif scor >= 30:
            return "üü° RISC MODERAT"
        else:
            return "üü¢ RISC SCƒÇZUT"
    
    def genereaza_recomandari(self, scor):
        """GenereazƒÉ recomandƒÉri bazate pe scor"""
        if scor >= 100:
            return [
                "üö® ALERTƒÇ CPIAAM IMEDIATƒÇ",
                "üß™ Screening MDR urgent (2h)",
                "üîí Izolare strict p√¢nƒÉ la rezultate",
                "üíä ATB empiricƒÉ spectru foarte larg",
                "üìû Consultare infectionist STAT"
            ]
        elif scor >= 75:
            return [
                "‚è∞ AlertƒÉ CPIAAM √Æn 2 ore",
                "üß™ Screening MDR obligatoriu",
                "üîí Izolare preventivƒÉ",
                "üíä Considerare ATB spectru larg",
                "üìä Monitorizare intensivƒÉ"
            ]
        elif scor >= 50:
            return [
                "üìû Consultare CPIAAM √Æn 6h",
                "üß™ Recoltare culturi complete",
                "üß§ Precau»õii contact standard",
                "üìà Monitorizare zilnicƒÉ",
                "üîÑ Reevaluare la 48h"
            ]
        elif scor >= 30:
            return [
                "üëÅÔ∏è Supraveghere activƒÉ IAAM",
                "üß§ Bundle preven»õie standard",
                "üìä Monitorizare parametri",
                "üîÑ Reevaluare la 72h"
            ]
        else:
            return [
                "üëÅÔ∏è Monitorizare standard",
                "üß§ MƒÉsuri preventive de bazƒÉ",
                "üìã Documentare corespunzƒÉtoare"
            ]
    
    def creeaza_gauge_risc(self, scor, titlu="Scor Risc IAAM"):
        """CreeazƒÉ gauge pentru afi»ôarea riscului"""
        if scor >= 75:
            color = "red"
            nivel = "CRITIC"
        elif scor >= 50:
            color = "orange"
            nivel = "√éNALT"
        elif scor >= 30:
            color = "yellow"
            nivel = "MODERAT"
        else:
            color = "green"
            nivel = "SCƒÇZUT"
        
        fig = go.Figure(go.Indicator(
            mode="gauge+number",
            value=scor,
            domain={'x': [0, 1], 'y': [0, 1]},
            title={'text': f"{titlu}<br><span style='font-size:0.8em;color:gray'>Nivel: {nivel}</span>"},
            gauge={
                'axis': {'range': [None, 100]},
                'bar': {'color': color},
                'steps': [
                    {'range': [0, 30], 'color': "lightgreen"},
                    {'range': [30, 50], 'color': "yellow"},
                    {'range': [50, 75], 'color': "orange"},
                    {'range': [75, 100], 'color': "red"}
                ],
                'threshold': {
                    'line': {'color': "red", 'width': 4},
                    'thickness': 0.75,
                    'value': 75
                }
            }
        ))
        
        fig.update_layout(height=300, margin=dict(l=20, r=20, t=60, b=20))
        return fig
    
    def creeaza_grafic_trend(self):
        """Grafic demonstrativ trend IAAM"""
        dates = pd.date_range(start='2024-01-01', end='2024-12-31', freq='W')
        cazuri = np.random.poisson(3, len(dates))
        
        fig = go.Figure()
        fig.add_trace(go.Scatter(
            x=dates,
            y=cazuri,
            mode='lines+markers',
            name='Cazuri IAAM',
            line=dict(color='red', width=2),
            marker=dict(size=4)
        ))
        
        fig.add_hline(y=np.mean(cazuri), 
                     line_dash="dash", line_color="gray",
                     annotation_text="Media anualƒÉ")
        
        fig.update_layout(
            title="üìà Trend Cazuri IAAM - Ultimele 12 Luni",
            xaxis_title="Data",
            yaxis_title="NumƒÉr Cazuri",
            height=400
        )
        
        return fig
    
    def creeaza_comparatie_sectii(self):
        """Grafic compara»õie sec»õii"""
        sectii = ['ATI', 'Chirurgie', 'Medicina InternƒÉ', 'Pediatrie', 'Cardiologie']
        rate_iaam = [37.5, 12.8, 8.2, 12.6, 5.3]
        
        colors = ['red' if x > 20 else 'orange' if x > 10 else 'green' for x in rate_iaam]
        
        fig = go.Figure(go.Bar(
            x=sectii,
            y=rate_iaam,
            marker_color=colors,
            text=[f"{x:.1f}%" for x in rate_iaam],
            textposition='auto'
        ))
        
        fig.update_layout(
            title="üè• Rata IAAM pe Sec»õii",
            xaxis_title="Sec»õie",
            yaxis_title="Rata IAAM (%)",
            height=400,
            showlegend=False
        )
        
        return fig

def main():
    """Func»õia principalƒÉ"""
    
    # Ini»õializare session state
    if 'evaluate' not in st.session_state:
        st.session_state.evaluate = False
    
    # Ini»õializare predictor
    predictor = IAAMPredictor()
    
    # Header principal
    st.markdown("""
    <div class="main-header">
        <h1>üè• SISTEM PREDIC»öIE IAAM - DASHBOARD PROFESIONAL</h1>
        <p>Dr. Boghian Lucian - Doctorat Epidemiologie - UMF "Grigore T. Popa" Ia»ôi</p>
        <p>Validat conform: Ord. 1101/2016 | CNSCBT | ECDC HAI-Net v5.3</p>
    </div>
    """, unsafe_allow_html=True)
    
    # === SIDEBAR PENTRU INPUT ===
    st.sidebar.header("üìã Evaluare Pacient")
    
    # Date identificare
    nume_pacient = st.sidebar.text_input("Nume/Cod Pacient", "Pacient Demo")
    
    # Date temporale
    st.sidebar.subheader("üìÖ Date Temporale")
    ore_spitalizare = st.sidebar.number_input("Ore de la internare", 0, 720, 96)
    
    # Factori Carmeli
    st.sidebar.subheader("üéØ Factori Carmeli MDR")
    spitalizare_90zile = st.sidebar.checkbox("Spitalizare √Æn ultimele 90 zile")
    antibiotice_30zile = st.sidebar.checkbox("Antibiotice √Æn ultimele 30 zile")
    rezidenta_ilp = st.sidebar.checkbox("Reziden»õƒÉ √Æn institu»õie")
    
    # Dispozitive medicale
    st.sidebar.subheader("üîß Dispozitive Medicale")
    cvc = st.sidebar.checkbox("Cateter venos central")
    ventilatie = st.sidebar.checkbox("Ventila»õie mecanicƒÉ")
    sonda_urinara = st.sidebar.checkbox("SondƒÉ urinarƒÉ")
    traheostomie = st.sidebar.checkbox("Traheostomie")
    drenaj = st.sidebar.checkbox("Drenaj activ")
    
    # Date demografice
    st.sidebar.subheader("üë§ Date Demografice")
    varsta = st.sidebar.number_input("V√¢rsta (ani)", 0, 120, 65)
    
    # ComorbiditƒÉ»õi
    st.sidebar.subheader("ü©∫ ComorbiditƒÉ»õi")
    diabet = st.sidebar.checkbox("Diabet zaharat")
    imunosupresie = st.sidebar.checkbox("Imunosupresie")
    bpoc = st.sidebar.checkbox("BPOC")
    insuf_renala = st.sidebar.checkbox("Insuficien»õƒÉ renalƒÉ")
    neoplasm = st.sidebar.checkbox("Neoplasm activ")
    
    # Laboratoare
    st.sidebar.subheader("üß™ Analize Laborator")
    leucocite = st.sidebar.number_input("Leucocite (/mmc)", 0, 50000, 7000)
    crp = st.sidebar.number_input("CRP (mg/L)", 0.0, 500.0, 5.0)
    pct = st.sidebar.number_input("ProcalcitoninƒÉ (ng/mL)", 0.0, 50.0, 0.1)
    
    # Microbiologie
    st.sidebar.subheader("ü¶† Microbiologie")
    cultura_pozitiva = st.sidebar.checkbox("CulturƒÉ pozitivƒÉ")
    bacterie = ""
    if cultura_pozitiva:
        bacterie = st.sidebar.selectbox(
            "Bacterie identificatƒÉ",
            [""] + list(predictor.bacterii_mdr.keys())
        )
    
    # Buton evaluare
    if st.sidebar.button("üîç EVALUEAZƒÇ RISC IAAM", type="primary"):
        st.session_state.evaluate = True
    
    # Reset
    if st.sidebar.button("üîÑ Reset"):
        st.session_state.evaluate = False
        st.rerun()
    
    # === MAIN DASHBOARD ===
    
    # PregƒÉtire date pentru evaluare
    date_pacient = {
        'nume_pacient': nume_pacient,
        'ore_spitalizare': ore_spitalizare,
        'spitalizare_90zile': spitalizare_90zile,
        'antibiotice_30zile': antibiotice_30zile,
        'rezidenta_ilp': rezidenta_ilp,
        'cvc': cvc,
        'ventilatie': ventilatie,
        'sonda_urinara': sonda_urinara,
        'traheostomie': traheostomie,
        'drenaj': drenaj,
        'varsta': varsta,
        'diabet': diabet,
        'imunosupresie': imunosupresie,
        'bpoc': bpoc,
        'insuf_renala': insuf_renala,
        'neoplasm': neoplasm,
        'leucocite': leucocite,
        'crp': crp,
        'pct': pct,
        'cultura_pozitiva': cultura_pozitiva,
        'bacterie': bacterie
    }
    
    # Evaluare dacƒÉ butonul a fost apƒÉsat
    if st.session_state.get('evaluate', False):
        
        try:
            # Calculare scor
            scor, nivel_risc, detalii, recomandari = predictor.calculeaza_scor_iaam(date_pacient)
            
            if scor == 0:
                st.error("‚ùå **PACIENTUL NU √éNDEPLINE»òTE CRITERIUL TEMPORAL PENTRU IAAM**")
                st.info("Evalua»õi pentru infec»õie comunitarƒÉ")
            else:
                # Row 1: Metrici principale
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    st.metric("üéØ Scor Total IAAM", f"{scor} puncte", f"vs. medie (45p)")
                
                with col2:
                    nivel_text = nivel_risc.split(' ')[1] if ' ' in nivel_risc else nivel_risc
                    st.metric("üìä Nivel Risc", nivel_text, "Evaluare automatƒÉ")
                
                with col3:
                    carmeli_score = sum([spitalizare_90zile, antibiotice_30zile, rezidenta_ilp])
                    st.metric("üéØ Scor Carmeli", f"{carmeli_score}/3", "MDR predictor")
                
                with col4:
                    st.metric("‚è±Ô∏è Evaluare", datetime.now().strftime("%H:%M"), "Timp real")
                
                # Row 2: Gauge »ôi predic»õie ML
                col1, col2 = st.columns(2)
                
                with col1:
                    fig_gauge = predictor.creeaza_gauge_risc(scor, "Scor Risc IAAM")
                    st.plotly_chart(fig_gauge, use_container_width=True)
                
                with col2:
                    # Simulare predic»õie ML
                    ml_score = min(100, max(0, scor + np.random.normal(0, 5)))
                    fig_ml = predictor.creeaza_gauge_risc(int(ml_score), "Predic»õie ML")
                    st.plotly_chart(fig_ml, use_container_width=True)
                
                # Row 3: Detalii »ôi recomandƒÉri
                col1, col2 = st.columns(2)
                
                with col1:
                    st.subheader("üìã Criterii Evaluate")
                    for i, detaliu in enumerate(detalii, 1):
                        st.write(f"{i}. {detaliu}")
                    
                    # Date microbiologice
                    if cultura_pozitiva and bacterie:
                        st.subheader("ü¶† Date Microbiologice")
                        st.info(f"**Bacterie:** {bacterie}")
                        if bacterie in predictor.bacterii_mdr:
                            st.warning(f"**Posibile rezisten»õe:** {', '.join(predictor.bacterii_mdr[bacterie])}")
                
                with col2:
                    st.subheader("üí° RecomandƒÉri Clinice")
                    
                    # AlertƒÉ criticƒÉ
                    if scor >= 100:
                        st.markdown('<div class="alert-critical">üö® <strong>ALERTƒÇ CRITICƒÇ IAAM</strong></div>', 
                                  unsafe_allow_html=True)
                    elif scor >= 75:
                        st.markdown('<div class="alert-warning">‚ö†Ô∏è <strong>RISC FOARTE √éNALT IAAM</strong></div>', 
                                  unsafe_allow_html=True)
                    
                    for i, rec in enumerate(recomandari, 1):
                        st.write(f"{i}. {rec}")
                    
                    # Timeline urmƒÉrire
                    st.subheader("‚è∞ Timeline UrmƒÉrire")
                    if scor >= 75:
                        st.write("- üïê **Imediat:** AlertƒÉ CPIAAM")
                        st.write("- üïë **2h:** Screening MDR")
                        st.write("- üïï **6h:** Reevaluare clinicƒÉ")
                    else:
                        st.write("- üïï **6h:** Consultare CPIAAM")
                        st.write("- üìÖ **24h:** Monitorizare evolu»õie")
                        st.write("- üìÖ **72h:** Reevaluare completƒÉ")
                
                # Raport pentru export
                st.subheader("üìÑ Raport Detaliat")
                
                raport = f"""
**RAPORT EVALUARE RISC IAAM**
- **Pacient:** {nume_pacient}
- **Data evaluƒÉrii:** {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
- **Versiune sistem:** {predictor.version}

**REZULTATE:**
- **Scor total:** {scor} puncte
- **Nivel risc:** {nivel_risc}
- **Criterii √Ændeplinite:** {len(detalii)}

**FACTORI DE RISC:**
- Ore spitalizare: {ore_spitalizare}h
- Scor Carmeli: {carmeli_score}/3
- V√¢rsta: {varsta} ani
- CulturƒÉ pozitivƒÉ: {'Da' if cultura_pozitiva else 'Nu'}

**RECOMANDƒÇRI:**
{chr(10).join([f"- {rec}" for rec in recomandari])}

**REFERIN»öE:**
- Ord. MS 1101/2016 - Art. 3, 5, 7
- CNSCBT - Defini»õii IAAM 2023
- ECDC HAI-Net Protocol v5.3
                """
                
                st.text_area("Raport pentru copiere", raport, height=300)
                
                # Buton descƒÉrcare
                st.download_button(
                    label="üì• DescarcƒÉ Raport JSON",
                    data=json.dumps(date_pacient, indent=2, ensure_ascii=False),
                    file_name=f"raport_iaam_{nume_pacient}_{datetime.now().strftime('%Y%m%d_%H%M')}.json",
                    mime="application/json"
                )
        
        except Exception as e:
            st.error(f"‚ùå Eroare la calcularea scorului: {str(e)}")
    
    # === DASHBOARD GENERAL (MEREU VIZIBIL) ===
    st.subheader("üìä Dashboard General IAAM")
    
    col1, col2 = st.columns(2)
    
    with col1:
        fig_trend = predictor.creeaza_grafic_trend()
        st.plotly_chart(fig_trend, use_container_width=True)
    
    with col2:
        fig_sections = predictor.creeaza_comparatie_sectii()
        st.plotly_chart(fig_sections, use_container_width=True)
    
    # Statistici rapide
    st.subheader("üìà Statistici Rapide")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("Cazuri IAAM azi", "3", "‚Üë 1")
    with col2:
        st.metric("Rata sƒÉptƒÉm√¢nalƒÉ", "12.5%", "‚Üì 2.3%")
    with col3:
        st.metric("Sec»õii monitorizate", "15", "‚Üí")
    with col4:
        st.metric("Alerte active", "2", "‚Üë 1")
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; color: gray;'>
        <p>üè• IAAM Predictor v2.0 | UMF "Grigore T. Popa" Ia»ôi | Dr. Boghian Lucian</p>
        <p>Validat conform Ord. 1101/2016, CNSCBT, ECDC HAI-Net Protocol v5.3</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()